import org.joda.time.*
import org.openhab.core.library.types.*
import org.openhab.model.script.actions.*
import org.openhab.core.persistence.*

val boolean previsdark = false
val boolean lightsOffForTheNight = false
val boolean prevsomeoneIsHome = false

rule "Turn Off Lights at Midnight"
  when
    Time cron "0 0 0 ? * * *"
  then
    logDebug("rules", "Turn off Lights at Midnight")
    sendCommand(Living_Room_Lamp_Dimmer, 0)
    sendCommand(Kitchen_Lamp_Dimmer, 0)
    lightsOffForTheNight = true
  end
  
rule "Turn On/Off Lights at Dusk/Dawn"
  when
    Time cron "0 * * * * ?"
  then
    var DateTime daystart = new DateTime((dawnEnd.state as DateTimeType).calendar.timeInMillis)
    var DateTime dayend = new DateTime((duskEnd.state as DateTimeType).calendar.timeInMillis)
    val boolean isdark = now.isBefore(daystart) || now.isAfter(dayend)
    //logDebug("rules", "Current "+isdark)
    //logDebug("rules", "Prev "+previsdark)
    
    // Living Room Light
    if (isdark && previsdark == false) {
      logDebug("rules", "It's Dark transition!")
      sendCommand(Living_Room_Lamp_Dimmer, 100)
    } else if (previsdark && isdark == false) {
      logDebug("rules", "It's Light transition!")
      lightsOffForTheNight = false
      sendCommand(Living_Room_Lamp_Dimmer, 0)
    }
    
    // Only want to see a lamp command on transition
    previsdark = isdark
    if (someoneIsHome.state == ON) {
      prevsomeoneIsHome = true
    } else {
      prevsomeoneIsHome = false
    }
  end

rule "Light Switch!"
  when
    Item GreatRoomSwitch received update
  then
    if (GreatRoomSwitch.state == ON) {
      logDebug("rules", "Light Switch ON!")
      sendCommand(Living_Room_Lamp_Dimmer, 100)
      sendCommand(Kitchen_Lamp_Dimmer, 100)
    } else if (GreatRoomSwitch.state == OFF) {
      logDebug("rules", "Light Switch OFF!")
      sendCommand(Living_Room_Lamp_Dimmer, 0)
      sendCommand(Kitchen_Lamp_Dimmer, 0)
    }
  end

rule "Basement Stair Light"
  when 
    Item BasementStairsSwitch changed
  then
    if (BasementStairsSwitch.state == ON) {
      logDebug("rules", "Stair Switch ON - Turn On Receiver & Projector")
      sendCommand(BasementProjectorSpot, 100)
      sendCommand(epsonPower, ON)
      sendCommand(integraPower, ON)
      createTimer(now.plusSeconds(20)) [| sendCommand(BasementProjectorSpot, 0)]
    } else if (BasementStairsSwitch.state == OFF) {
      sendCommand(BasementProjectorSpot, 0)
    }
  end
  
